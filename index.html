<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR.js – single looping video</title>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

    <script>
      let videoPlane = null;           // global reference – we create exactly ONE

      AFRAME.registerComponent('video-handler', {
        init() {
          const marker = this.el;
          const scene  = marker.sceneEl;

          // run once, the first time the pattern is detected
          marker.addEventListener('markerFound', () => {
            if (!videoPlane) {
              const videoEl = document.querySelector('#markerVideo');
              videoEl.loop   = true;    // redundancy – loop attribute is in HTML too
              videoEl.muted  = true;    // allow autoplay on mobile
              videoEl.play();

              // create the textured plane
              videoPlane = document.createElement('a-plane');
              videoPlane.setAttribute('material', 'src: #markerVideo; transparent: true');
              videoPlane.setAttribute('width', 1);
              videoPlane.setAttribute('height', 0.5625);
              scene.appendChild(videoPlane);
            }
            // snap plane to the marker immediately
            this.updatePlanePose();
          });
        },

        // every frame: keep plane aligned with the live marker pose
        tick() {
          if (videoPlane) {
            this.updatePlanePose();
          }
        },

        updatePlanePose() {
          const markerObj = this.el.object3D;
          const planeObj  = videoPlane.object3D;

          planeObj.position.copy(markerObj.getWorldPosition(new THREE.Vector3()));
          planeObj.quaternion.copy(markerObj.getWorldQuaternion(new THREE.Quaternion()));
        }
      });
    </script>
  </head>

  <body style="margin:0; overflow:hidden;">
    <a-scene embedded arjs="sourceType: webcam;">
      <a-assets>
        <!-- the looping MP4 -->
        <video id="markerVideo"
               src="test4.mp4"
               crossorigin="anonymous"
               webkit-playsinline
               playsinline
               loop></video>
      </a-assets>

      <!-- your .patt marker now has the custom component -->
      <a-marker type="pattern" url="test.patt" video-handler></a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
