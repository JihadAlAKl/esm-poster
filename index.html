<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR.js – auto portrait / landscape video</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

  <style>
    body {margin:0; overflow:hidden;}
    #status {
      position:fixed; top:10px; left:10px;
      padding:6px 12px; font:700 16px/1 sans-serif;
      background:rgba(0,0,0,.55); color:#0f0;
      border-radius:4px; display:none; user-select:none;
    }
  </style>

  <script>
    AFRAME.registerComponent('video-handler', {
      init() {
        const marker = this.el;
        const scene  = marker.sceneEl;
        const hud    = document.getElementById('status');

        this.videoPlane = null;
        this.allowRelocate = false;          // let us move the plane after markerLost

        const ROT_X_NEG_90 = new THREE.Quaternion()
                              .setFromEuler(new THREE.Euler(-Math.PI/2, 0, 0));

        /* ------------------------------------------------------------------
         * Produce the final quaternion for the plane:
         *   planeQ = markerQ × X(-90°) × Z(dynamic 0|90°)
         * -----------------------------------------------------------------*/
        const computePlaneQuaternion = (markerQ) => {
          // marker yaw in radians (-π … π)
          const yaw = new THREE.Euler().setFromQuaternion(markerQ, 'ZYX').z;
          // is yaw an even multiple of 90°?   0,±180 → true  |  ±90 → false
          const evenQuad = (Math.round(yaw / (Math.PI / 2)) & 1) === 0;
          const rotZ = evenQuad ? Math.PI/2 : 0;

          const q = markerQ.clone()
                           .multiply(ROT_X_NEG_90)
                           .multiply(new THREE.Quaternion()
                                     .setFromAxisAngle(new THREE.Vector3(0,0,1), rotZ));
          return q;
        };

        /* ---------------- helper: place or move the plane ---------------- */
        const placePlane = () => {
          if (!this.videoPlane) return;
          const obj  = marker.object3D;
          const pl   = this.videoPlane.object3D;

          pl.position.copy(obj.getWorldPosition(new THREE.Vector3()));
          pl.quaternion.copy( computePlaneQuaternion(obj.getWorldQuaternion(
                                  new THREE.Quaternion())) );
        };

        /* -------------------- marker events -------------------- */
        marker.addEventListener('markerFound', () => {
          hud.style.display = 'block';

          if (!this.videoPlane) {            // first time – create everything
            const vid = document.querySelector('#markerVideo');
            vid.muted = true; vid.loop = true;

            /* Wait for metadata so we know aspect ratio */
            vid.addEventListener('loadedmetadata', () => {
              const ar   = vid.videoWidth / vid.videoHeight || 1;  // width / height
              const w    = ar >= 1 ? 1          : ar;   // longer side = 1
              const h    = ar >= 1 ? 1 / ar     : 1;

              this.videoPlane = document.createElement('a-plane');
              this.videoPlane.setAttribute('material',
                'src: #markerVideo; transparent: true;');
              this.videoPlane.setAttribute('width',  w);
              this.videoPlane.setAttribute('height', h);
              scene.appendChild(this.videoPlane);

              vid.play();
              placePlane();                  // snap to current pose
            }, {once:true});
          } else if (this.allowRelocate) {
            placePlane();                    // move existing plane
            this.allowRelocate = false;
          }
        });

        marker.addEventListener('markerLost', () => {
          hud.style.display = 'none';
          this.allowRelocate = true;         // let plane follow image next time
        });

        /* every frame keep the plane glued to the latest pose */
        this.tick = () => placePlane();
      }
    });
  </script>
</head>

<body>
  <div id="status">DETECTED</div>

  <a-scene embedded arjs="sourceType: webcam;">
    <a-assets>
      <!-- Your MP4 (any aspect ratio) -->
      <video id="markerVideo"
             src="test4.mp4"
             playsinline webkit-playsinline crossorigin="anonymous">
      </video>
    </a-assets>

    <!-- Pattern marker with the component -->
    <a-marker type="pattern" url="test.patt" video-handler></a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
