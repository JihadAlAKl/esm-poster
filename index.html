<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR.js – single looping video (flat)</title>

    <!-- A-Frame + AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>

    <script>
      let videoPlane = null;                 // we still spawn exactly ONE plane
      const CORRECTION_Q = new THREE.Quaternion()
                            .setFromEuler(new THREE.Euler(-Math.PI / 2, 0, 0)); // –90° about X

      AFRAME.registerComponent('video-handler', {
        init() {
          const marker = this.el;
          const scene  = marker.sceneEl;

          marker.addEventListener('markerFound', () => {
            if (!videoPlane) {
              const vid = document.querySelector('#markerVideo');
              vid.loop  = true;
              vid.muted = true;
              vid.play();

              videoPlane = document.createElement('a-plane');
              videoPlane.setAttribute('material',
                                      'src: #markerVideo; transparent: true;');
              videoPlane.setAttribute('width', 1);        // matches marker size
              videoPlane.setAttribute('height', 1);       // square marker (adjust if yours differs)
              scene.appendChild(videoPlane);
            }
            this.updatePlanePose();                       // snap immediately
          });
        },

        tick() { if (videoPlane) this.updatePlanePose(); },

        updatePlanePose() {
          const markerObj = this.el.object3D;
          const planeObj  = videoPlane.object3D;

          // position
          planeObj.position.copy(
            markerObj.getWorldPosition(new THREE.Vector3())
          );

          // orientation  = marker rotation × (–90° X-axis)
          planeObj.quaternion.copy(
            markerObj.getWorldQuaternion(new THREE.Quaternion())
          ).multiply(CORRECTION_Q);
        }
      });
    </script>
  </head>

  <body style="margin:0; overflow:hidden;">
    <a-scene embedded arjs="sourceType: webcam;">
      <a-assets>
        <video id="markerVideo"
               src="test.mp4"
               crossorigin="anonymous"
               webkit-playsinline
               playsinline
               loop></video>
      </a-assets>

      <!-- attach our component -->
      <a-marker type="pattern" url="test.patt" video-handler></a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
